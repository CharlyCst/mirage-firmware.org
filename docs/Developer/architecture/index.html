<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Developer/architecture" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Architecture | Miralis</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://miralis-firmware.github.io/img/social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://miralis-firmware.github.io/img/social-card.jpg"><meta data-rh="true" property="og:url" content="https://miralis-firmware.github.io/docs/Developer/architecture"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Architecture | Miralis"><meta data-rh="true" name="description" content="Overview"><meta data-rh="true" property="og:description" content="Overview"><link data-rh="true" rel="icon" href="/favicon/favicon.ico"><link data-rh="true" rel="canonical" href="https://miralis-firmware.github.io/docs/Developer/architecture"><link data-rh="true" rel="alternate" href="https://miralis-firmware.github.io/docs/Developer/architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://miralis-firmware.github.io/docs/Developer/architecture" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Miralis RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Miralis Atom Feed">
<link rel="alternate" type="application/json" href="/blog/feed.json" title="Miralis JSON Feed"><link rel="stylesheet" href="/assets/css/styles.49764aa3.css">
<script src="/assets/js/runtime~main.7696be9d.js" defer="defer"></script>
<script src="/assets/js/main.3bc47d8e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/miralis_icon.svg" alt="Miralis logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/miralis_icon.svg" alt="Miralis logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Miralis</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/charlycst/miralis" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/intro">Getting Started</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/faq">FAQ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/docs/Developer/architecture">Developer</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Developer/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Developer/contributing">Contributing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Developer/terminology">Terminology</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Developer/tooling">Tooling</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Developer</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Architecture</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Architecture</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview" href="/docs/Developer/architecture#overview">​</a></h2>
<p>The purpose of Miralis is to virtualize firmware.
In a standard RISC-V deployment, the firmware runs in M-mode, below the OS:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        ┌──────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">U-mode  │   User App   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├──────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">S-mode  │      OS      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├──────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">M-mode  │   Firmware   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        └──────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Because M-mode is all-powerful, it has absolute control over the OS, including reading and modifying its data.
The traditional purpose of the firmware is the manage the SoC, that is initializing and configuring all devices, manage power, monitor temperature and device health, etc...
In addition, the firmware is increasingly used for security-critical features, such as enforcing isolation.
For instance, on Arm the firmware (EL3 on that architecture) is responsible for enforcing the security guarantees of confidential VMs (see Arm CCA extension).</p>
<p>We end-up in a situation where the firmware has two roles: to manage the physical board, and to enforce security policies.
Unfortunately those two roles are in tension: hardware manufacturers tend to ship opaque firmware blob to manage proprietary hardware, while security require measured and open-source software to allow scrutiny.</p>
<p>The purpose of Miralis is decouple those two functions: on one hand it can support opaque firmware for managing the board, and on the other it can enforce security by isolating the OS.
The way Miralis achieve this is through firmware virtualization.
At a high level, a deployment on top of Miralis looks like this:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">        ┌──────────────┐ ┌────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">U-mode  │   User App   │ │  Firmware  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├──────────────┤ └────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">S-mode  │      OS      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ├──────────────┴──────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">M-mode  │           Miralis           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        └─────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Miralis itself runs in M-mode in the place where one would usually find the firmware.
But because the hardware still requires a firmware to function properly, Miralis actually runs the firmware in U-mode and virtualizes all privileged operations, such as interacting with M-mode registers.
At the same time, Miralis allows running a standard OS like it usually would, in S-mode.
The OS can call into the firmware, and miralis will take care of forwarding those calls appropriately.
That way, Miralis manages to keep all the firmware functionalities, but can enforce strong security guarantees, such as ensuring that the firmware can never access the  OS memory.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="pmp-virtualization">PMP Virtualization<a class="hash-link" aria-label="Direct link to PMP Virtualization" title="Direct link to PMP Virtualization" href="/docs/Developer/architecture#pmp-virtualization">​</a></h2>
<p>One of the main aspect of OS virtualization is MMU (Memory Management Unit) virtualization.
The MMU can be virtualized using either pure software shadow page tables, or using hardware assisted 2-level page tables.</p>
<p>In the case of Miralis we have no such concerns, because M-mode doesn&#x27;t have access to an MMU (S-mode does, but Miralis doesn&#x27;t need to virtualize it).
Instead, M-mode has access to PMP (Physical Memory Protection) registers, which falls under the category of MPU (Memory Protection Unit) often found in embedded micro-controllers.
Miralis needs to protect its own memory using PMP while still exposing PMP to the firmware to protect itself from the OS.
For that purpose Miralis needs to virtualize and multiplex the physical PMP registers.</p>
<p>PMP registers form an ordered list of physical memory ranges with attached access rights.
The first entry that matches a given address determines the access rights for that particular load or store.
For more details regarding PMP, please refer to the RISC-V privileged specification.</p>
<p>Miralis split PMP registers in four groups, as depicted bellow with the example of 8 physical PMP registers:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────┐ ─┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  PMP 0  │  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────┤  │ For Miralis use</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  PMP 1  │  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────┤ ─┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    0    │  │ Null entry</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────┤ ─┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ vPMP 0  │  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────┤  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ vPMP 1  │  │ Virtual PMP registers,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────┤  │ dedicated for firmware</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ vPMP 2  │  │ use</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────┤  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ vPMP 3  │  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────┤ ─┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   All   │  │ Default allow/deny all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────┘ ─┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The first few registers are reserved for Miralis&#x27;s own use.
They are placed first to take priority over firmware-controlled PMP registers.
Then Miralis inserts a null entry with address 0, this is required to ensure that the first virtual PMP behaves like the first physical PMP when using TOR (Top Of Range) addressing (refer to the spec for details).
Then the next PMP registers are exposed to the firmware as virtual PMP registers.
From the firmware point of view, it looks like if there were only PMP 0 to 3 in the example above.
Finally, the last entry is used by Miralis to either allow access to all memory when running the firmware (to emulate full memory access in virtual M-mode), or disallow all access when running in S or U-mode.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="interrupts">Interrupts<a class="hash-link" aria-label="Direct link to Interrupts" title="Direct link to Interrupts" href="/docs/Developer/architecture#interrupts">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="riscv-interrupt-system">RISCV interrupt system<a class="hash-link" aria-label="Direct link to RISCV interrupt system" title="Direct link to RISCV interrupt system" href="/docs/Developer/architecture#riscv-interrupt-system">​</a></h3>
<p>When the firmware is running, we want to receive all interrupts the firmware wants to receive. Theses enabled interrupts can be known by having a look at some virtuals context registers:</p>
<ol>
<li><code>mie</code> register informs us on the individually enabled interrupts. <code>mip</code> register holds the pending interrupts by setting the corresponding bit when an interrupt occurs. A pending interrupt can trap only if the corresponding bit in <code>mie</code> and in <code>mip</code> is set. Here is the layout of both registers. Please refer to the <a href="https://drive.google.com/file/d/17GeetSnT5wW3xNuAHI95-SI1gPGd5sJ_/view?usp=drive_link" target="_blank" rel="noopener noreferrer">specification</a> for the detailed explanation of each field.</li>
</ol>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">      15 14  13  12  11 10   9  8   7  6   5  4   3  2   1  0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ┌───┬──────┬─┬────┬─┬────┬─┬────┬─┬────┬─┬────┬─┬────┬─┐          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mie : │0 0│LCOFIE│0│MEIE│0│SEIE│0│MTIE|0|STIE|0|MSIE|0|SSIE|0|       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      └───┴──────┴─┴────┴─┴────┴─┴────┴─┴────┴─┴────┴─┴────┴─┘   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      15 14  13  12  11 10   9  8   7  6   5  4   3  2   1  0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ┌───┬──────┬─┬────┬─┬────┬─┬────┬─┬────┬─┬────┬─┬────┬─┐          </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mip : │0 0│LCOFIP│0│MEIP│0│SEIP│0│MTIP|0|STIP|0|MSIP|0|SSIP|0|       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      └───┴──────┴─┴────┴─┴────┴─┴────┴─┴────┴─┴────┴─┴────┴─┘         </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol start="2">
<li>
<p><code>mideleg</code> register allows delegating interrupts to less-privileged mode. The layout of <code>mideleg</code> matches the one of <code>mie</code> and <code>mip</code>. If an interrupt is pending and delegated, it will not trap, whatever the value in <code>mie</code>.</p>
</li>
<li>
<p>The MIE bit in the <code>mstatus</code> register control if interrupts are globally enabled for machine mode. If <code>mstatus.MIE</code> is disabled and an interrupt is pending, it will not trap, whatever the values in <code>mie</code> and <code>mideleg</code>. If the running mode is less than M, global interrupts for M-mode are always enabled.</p>
</li>
</ol>
<p>To sum up, in riscv, in order to trap to M-Mode, we need:</p>
<blockquote>
<p><strong>(RISCV-SPEC)</strong><br>
<!-- -->Executing mode = <strong>M</strong>:<br>
<code>trap ⟺ mip[i] ∧ mie[i] ∧ mstatus.MIE ∧ ¬mideleg[i]</code></p>
<p>Executing mode = <strong>S</strong>:<br>
<code>trap ⟺ mip[i] ∧ mie[i] ∧ ¬mideleg[i]</code></p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="miralis-interrupt-virtualization">Miralis interrupt virtualization<a class="hash-link" aria-label="Direct link to Miralis interrupt virtualization" title="Direct link to Miralis interrupt virtualization" href="/docs/Developer/architecture#miralis-interrupt-virtualization">​</a></h3>
<p>In order to properly virtualize interrupts and correctly handle them, we need to follow many rules. The goal is to ensure that all interrupts destined to the firmware are correctly virtualized, so that the firmware get exactly its destined interrupts.</p>
<p>We virtualize registers inside the virtual context of the firmware. Registers <code>mie</code>, <code>mip</code>, <code>mideleg</code>, <code>mstatus</code> will have their virtual counterparts <code>vmie</code>, <code>vmie</code>, <code>vmideleg</code> and <code>vmstatus</code>. In this section, we will also say that the firmware is running in <strong>vM-mode</strong> (M-mode virtualized by Miralis inside U-mode). Let&#x27;s now separate the cases into the three execution states that could occur:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="firmware">Firmware<a class="hash-link" aria-label="Direct link to Firmware" title="Direct link to Firmware" href="/docs/Developer/architecture#firmware">​</a></h4>
<p>When the firmware is running, we want Miralis to receive <strong>all</strong> interrupts the firmware expects to receive: no interrupt is delegated to firmware. We then set <code>mideleg</code> to 0 when executing the firmware. We also want to receive <strong>only</strong> interrupts the firmware expects to receive. We then must filter <code>mie</code> register to not trap on delegated interrupts or disabled interrupts. If an interrupt occurs, we need to reflect <code>mip</code> into <code>vmip</code> to let the firmware know which one.</p>
<blockquote>
<p><strong>(MIDELEG-VM-MODE)</strong><br>
<!-- -->mideleg ≡ 0, if mode = vM</p>
<p><strong>(MIE-VM-MODE)</strong><br>
<!-- -->mie = ¬vmideleg ∧ vmstatus.MIE ∧ vmie, if mode = vM</p>
<p><strong>(MIP-VM-MODE)</strong>
vmip = mip, if mode = vM</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="payload">Payload<a class="hash-link" aria-label="Direct link to Payload" title="Direct link to Payload" href="/docs/Developer/architecture#payload">​</a></h4>
<p>When switching to S-mode, we want to install <code>vmideleg</code> into <code>mideleg</code> and <code>vmie</code> to <code>mie</code>, because the states of <code>mideleg</code> and <code>mie</code> may influence S-mode interrupts handling.</p>
<blockquote>
<p><strong>(MIDELEG-S-MODE)</strong><br>
<!-- -->mideleg ≡ vmideleg, if mode = S</p>
<p><strong>(MIE-S-MODE)</strong><br>
<!-- -->mie ≡ vmie, if mode = S</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="miralis">Miralis<a class="hash-link" aria-label="Direct link to Miralis" title="Direct link to Miralis" href="/docs/Developer/architecture#miralis">​</a></h4>
<p>When Miralis is running, we don&#x27;t want to receive interrupts: we want to handle them one by one. A simple way to ensure that is to make sure that <code>mstatus.MIE</code> is always 0. As interrupts are globally enabled for M-mode when a less-privileged mode is running, Miralis will still get the interrupts of S-mode (e.g. payload) and U-mode (e.g. firmware).</p>
<blockquote>
<p><strong>(MSTATUS-MIE)</strong><br>
<!-- -->mstatus.MIE ≡ 0</p>
</blockquote>
<p>Now we show that if Miralis get an interrupt from firmware or the payload, it&#x27;s correctly forwarded to the firmware interrupt handler and the virtual context is properly set to a trap state for the firmware.</p>
<p>When running in <strong>vM-mode</strong>, we have the following properties:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">             ┌──────────┐      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         ┌──&gt;│ Firmware │───┐       (1) An interrupt occurs when the firmware is     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         │   └──────────┘   |           running. Switch to Miralis. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      (2)│                  |(1)    (2) Miralis virtualizes interrupt and       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         │                  |           transmit handling to firmware&#x27;s interrupt     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         │   ┌──────────┐   |           handler.   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         └───│ Miralis  │&lt;──┘                  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             └──────────┘       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Miralis receives interrupt i when executing firmware: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (RISCV-SPEC)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ⟹ mstatus.MIE = -, mie[i] = 1, mip[i] = 1, mideleg[i] = 0 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (MIE-VM-MODE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ⟹ vmstatus.MIE = 1, vmie[i] = 1, vmideleg[i] = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (MIP-VM-MODE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ⟹ vmip[i] = mip [i] = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Then, vmstatus.MIE = 1 ∧ vmip[i] = 1 ∧ vmie[i] = 1 ∧ vmideleg[i] = 0  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (RISCV-SPEC)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ⟹ virtual context is set as a tap occured in the firmware,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     we can forward interrupt handling to firmware. </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When running in <strong>S-mode</strong>, we have the following properties:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">  ┌─────────┐           ┌─────────┐ (1) An interrupt occurs when the payload is      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │ Payload │&lt;──┐   ┌──&gt;│Firmware │     running. Switch to Miralis. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  └─────────┘   │   │   └─────────┘ (2) Miralis virtualizes interrupt and transmit     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │    (4)│   │(2)    │           handling to firmware&#x27;s interrupt handler. </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     (1)│       │   │       │(3)    (3) Firmware&#x27;s handler handle interrupt then        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        │    ┌─────────┐    │           mret to payload.      </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        └───&gt;│ Miralis │&lt;───┘       (4) Miralis installs registers and emulate</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             └─────────┘                mret to payload.                                       </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Miralis receives interrupt i when executing payload: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (RISCV-SPEC) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ⟹ mstatus.MIE = -, mie[i] = 1, mip[i] = 1, mideleg[i] = 0  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (MIE-S-MODE, MIDELEG-S-MODE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ⟹ vmie[i] = 1, vmideleg[i] = 0 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (MIP-VM-MODE)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ⟹ vmip[i] = mip [i] = 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Then, vmstatus.MIE = - ∧ vmip[i] = 1 ∧ vmie[i] = 1 ∧ vmideleg[i] = 0  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (RISCV-SPEC)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ⟹ virtual context is set as a tap occured to the firmware,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     we can forward interrupt handling to firmware. </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/faq"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">FAQ</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Developer/contributing"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Contributing</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/docs/Developer/architecture#overview">Overview</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/Developer/architecture#pmp-virtualization">PMP Virtualization</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/Developer/architecture#interrupts">Interrupts</a><ul><li><a class="table-of-contents__link toc-highlight" href="/docs/Developer/architecture#riscv-interrupt-system">RISCV interrupt system</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/Developer/architecture#miralis-interrupt-virtualization">Miralis interrupt virtualization</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/intro">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/about">About</a></li><li class="footer__item"><a href="https://github.com/charlycst/miralis" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
</body>
</html>